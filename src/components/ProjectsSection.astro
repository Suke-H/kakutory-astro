---
import "../styles/projects-section.css";
import { projectsConfig } from "../config/projects";

/**
 * 想定データ形
 * projectsConfig.projects: Array<{
 *   title: string;
 *   description: string;
 *   technologies: string[];
 *   liveLink: string;
 *   githubLink: string;
 *   images: string[]; // ← ここ（なければ projectsConfig.images を流用しても可）
 *   date?: string;    // 任意
 * }>
 */
const projects = projectsConfig.projects;
---

<section class="projects-section">
  <div class="projects-container">
    <h2 class="projects-title">Projects</h2>

    <!-- ここから中身を差し替え（旧カルーセル/説明領域は削除） -->
    <div class="projects-grid">
      {projects.map((p, index) => (
        <article class="work-card">
          <button class="card-button" type="button" data-modal-open={index}>
            <img
              class="card-img"
              src={(p.images && p.images[0]) ? p.images[0] : projectsConfig.images?.[index] ?? ""}
              alt={p.title}
              loading="lazy"
            />
            <div class="card-body">
              <div class="card-title">{p.title}</div>

              {/* date が無ければ非表示 */}
              {p.date ? <div class="card-date">{p.date}</div> : null}

              <div class="chip-row">
                {p.technologies.map((t) => (
                  <span class="chip">{t}</span>
                ))}
              </div>
            </div>
          </button>
        </article>
      ))}
    </div>

    {projects.map((p, index) => {
      const imgs = (p.images && p.images.length > 0)
        ? p.images
        : (projectsConfig.images ? [projectsConfig.images[index]] : []);

      return (
        <dialog class="work-modal" data-modal={index} aria-label={`${p.title} details`}>
          <button class="modal-close" type="button" data-modal-close={index} aria-label="close">×</button>

          <div class="slider" data-slider={index}>
            <button class="slider-nav left" type="button" data-slide-prev={index} aria-label="prev">‹</button>

            <div class="slides" data-slides={index}>
              {imgs.map((src, idx) => (
                <figure class="slide" data-slide>
                  <img src={src} alt={`${p.title} - ${idx + 1}`} loading="lazy" />
                </figure>
              ))}
            </div>

            <button class="slider-nav right" type="button" data-slide-next={index} aria-label="next">›</button>
          </div>

          <h3 class="modal-title">{p.title}</h3>
          <hr class="divider" />

          <section class="section">
            <h4>説明</h4>
            <hr class="divider" />
            <p class="desc">{p.description}</p>
          </section>

          <section class="section">
            <h4>使用技術</h4>
            <hr class="divider" />
            <div class="chip-row modal-chips">
              {p.technologies.map((t) => (
                <span class="chip">{t}</span>
              ))}
            </div>
          </section>

          <section class="section">
            <h4>リンク</h4>
            <hr class="divider" />
            <div class="links">
              <a href={p.liveLink} class="link-btn" target="_blank" rel="noopener noreferrer">
                Live <span aria-hidden="true">→</span>
              </a>
              <a href={p.githubLink} class="link-btn" target="_blank" rel="noopener noreferrer">
                GitHub <span aria-hidden="true">→</span>
              </a>
            </div>
          </section>
        </dialog>
      );
    })}
    <!-- ここまで中身差し替え -->
  </div>
</section>

<script>
  // Astro は <script> でクライアント側のイベント処理を追加できます :contentReference[oaicite:5]{index=5}

  // モーダル開閉
  document.querySelectorAll("[data-modal-open]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-modal-open");
      const dialog = document.querySelector(`dialog[data-modal="${id}"]`);
      if (dialog && typeof dialog.showModal === "function") dialog.showModal();
    });
  });

  document.querySelectorAll("[data-modal-close]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-modal-close");
      const dialog = document.querySelector(`dialog[data-modal="${id}"]`);
      if (dialog) dialog.close();
    });
  });

  // 背景クリックで閉じる（dialogの一般的な実装） :contentReference[oaicite:6]{index=6}
  document.querySelectorAll("dialog.work-modal").forEach((dialog) => {
    dialog.addEventListener("click", (e) => {
      const rect = dialog.getBoundingClientRect();
      const inDialog =
        rect.top <= e.clientY && e.clientY <= rect.bottom &&
        rect.left <= e.clientX && e.clientX <= rect.right;
      if (!inDialog) dialog.close();
    });
  });

  // 依存なし簡易スライダー（scrollIntoView）
  function setupSlider(id) {
    const slidesEl = document.querySelector(`[data-slides="${id}"]`);
    if (!slidesEl) return;

    const slides = Array.from(slidesEl.querySelectorAll("[data-slide]"));
    if (slides.length <= 1) return;

    let index = 0;
    const go = (next) => {
      index = (next + slides.length) % slides.length;
      slides[index].scrollIntoView({ behavior: "smooth", inline: "start", block: "nearest" });
    };

    document.querySelector(`[data-slide-prev="${id}"]`)?.addEventListener("click", () => go(index - 1));
    document.querySelector(`[data-slide-next="${id}"]`)?.addEventListener("click", () => go(index + 1));
  }

  document.querySelectorAll("[data-slider]").forEach((el) => setupSlider(el.getAttribute("data-slider")));
</script>
