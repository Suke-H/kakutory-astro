---
import { projectsConfig } from "../config/projects";

/**
 * 想定データ形
 * projectsConfig.projects: Array<{
 *   title: string;
 *   description: string;
 *   technologies: string[];
 *   liveLink: string;
 *   githubLink: string;
 *   images: string[]; // ← ここ（なければ projectsConfig.images を流用しても可）
 *   date?: string;    // 任意
 * }>
 */
const projects = projectsConfig.projects;
---

<section class="projects-section">
  <div class="projects-container">
    <h2 class="projects-title">Projects</h2>

    <!-- ここから中身を差し替え（旧カルーセル/説明領域は削除） -->
    <div class="projects-grid">
      {projects.map((p, index) => (
        <article class="work-card">
          <button class="card-button" type="button" data-modal-open={index}>
            <img
              class="card-img"
              src={(p.images && p.images[0]) ? p.images[0] : projectsConfig.images?.[index] ?? ""}
              alt={p.title}
              loading="lazy"
            />
            <div class="card-body">
              <div class="card-title">{p.title}</div>

              {/* date が無ければ非表示 */}
              {p.date ? <div class="card-date">{p.date}</div> : null}

              <div class="chip-row">
                {p.technologies.map((t) => (
                  <span class="chip">{t}</span>
                ))}
              </div>
            </div>
          </button>
        </article>
      ))}
    </div>

    {projects.map((p, index) => {
      const imgs = (p.images && p.images.length > 0)
        ? p.images
        : (projectsConfig.images ? [projectsConfig.images[index]] : []);

      return (
        <dialog class="work-modal" data-modal={index} aria-label={`${p.title} details`}>
          <button class="modal-close" type="button" data-modal-close={index} aria-label="close">×</button>

          <div class="slider" data-slider={index}>
            <button class="slider-nav left" type="button" data-slide-prev={index} aria-label="prev">‹</button>

            <div class="slides" data-slides={index}>
              {imgs.map((src, idx) => (
                <figure class="slide" data-slide>
                  <img src={src} alt={`${p.title} - ${idx + 1}`} loading="lazy" />
                </figure>
              ))}
            </div>

            <button class="slider-nav right" type="button" data-slide-next={index} aria-label="next">›</button>
          </div>

          <h3 class="modal-title">{p.title}</h3>
          <hr class="divider" />

          <section class="section">
            <h4>説明</h4>
            <hr class="divider" />
            <p class="desc">{p.description}</p>
          </section>

          <section class="section">
            <h4>使用技術</h4>
            <hr class="divider" />
            <div class="chip-row modal-chips">
              {p.technologies.map((t) => (
                <span class="chip">{t}</span>
              ))}
            </div>
          </section>

          <section class="section">
            <h4>リンク</h4>
            <hr class="divider" />
            <div class="links">
              <a href={p.liveLink} class="link-btn" target="_blank" rel="noopener noreferrer">
                Live <span aria-hidden="true">→</span>
              </a>
              <a href={p.githubLink} class="link-btn" target="_blank" rel="noopener noreferrer">
                GitHub <span aria-hidden="true">→</span>
              </a>
            </div>
          </section>
        </dialog>
      );
    })}
    <!-- ここまで中身差し替え -->
  </div>
</section>

<style>
  /* Astro の <style> はデフォルトでコンポーネント内にスコープされます :contentReference[oaicite:3]{index=3} */

  .projects-title{
    text-align:center;
    margin: 0 0 24px;
    color:#585858;
    font-weight: 800;
  }

  .projects-grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 16px;
  }
  @media (max-width: 900px){ .projects-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
  @media (max-width: 600px){ .projects-grid{ grid-template-columns: 1fr; } }

  .card-button{
    width:100%;
    border:0;
    padding:0;
    background:transparent;
    cursor:pointer;
    text-align:left;
    border-radius:10px;
    overflow:hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,.08);
  }
  .card-img{ width:100%; height:auto; display:block; background:#f0f0f0; }
  .card-body{ padding: 14px 14px 16px; background:#fff; }
  .card-title{ font-size: 20px; font-weight:900; margin-bottom: 6px; color:#585858; }
  .card-date{ font-size: 12px; color: rgba(0,0,0,.55); margin-bottom: 10px; font-weight:600; }

  .chip-row{ display:flex; flex-wrap:wrap; gap:6px; }
  .chip{
    display:inline-flex;
    align-items:center;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight:800;
    border: 1px solid rgba(0,0,0,.12);
    background: rgba(0,0,0,.03);
    color:#585858;
  }
  .modal-chips{ margin-top: 6px; }

  /* dialog modal：showModal()/close() を使用 :contentReference[oaicite:4]{index=4} */
  .work-modal{
    width: min(900px, 90vw);
    border: 0;
    border-radius: 12px;
    padding: 22px 22px 26px;
    color:#585858;
    box-shadow: 0 12px 50px rgba(0,0,0,.25);
    position: relative;
  }
  .work-modal::backdrop{ background: rgba(0,0,0,.55); }

  .modal-close{
    position:absolute;
    top:10px; right:12px;
    width:36px; height:36px;
    border-radius:999px;
    border: 1px solid rgba(0,0,0,.12);
    background:#fff;
    cursor:pointer;
    font-size: 22px;
    line-height: 32px;
    color:#585858;
  }

  .modal-title{ font-size: 28px; font-weight: 900; margin: 18px 0 10px; }
  .divider{ border:0; border-top: 2px solid rgba(0,0,0,.12); margin: 10px 0 16px; }

  .section{ margin-top: 18px; }
  .section h4{ font-size: 18px; margin: 0 0 8px; font-weight: 900; }
  .desc{ margin: 0; color: rgba(0,0,0,.70); font-weight:700; line-height: 1.8; }

  .links{ display:flex; gap: 10px; flex-wrap: wrap; }
  .link-btn{
    display:inline-flex;
    align-items:center;
    gap: 6px;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,.12);
    background:#fff;
    color:#585858;
    font-weight: 900;
    text-decoration: none;
  }

  /* slider（依存なし） */
  .slider{ position: relative; margin-top: 6px; }
  .slides{
    display:flex;
    overflow-x:auto;
    scroll-snap-type: x mandatory;
    gap: 12px;
    border-radius: 10px;
  }
  .slide{ flex: 0 0 100%; scroll-snap-align: start; margin: 0; }
  .slide img{ width: 100%; display:block; border-radius: 10px; background:#f0f0f0; }

  .slider-nav{
    position:absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px; height: 40px;
    border-radius: 999px;
    border: 0;
    background: rgba(0,0,0,.55);
    color:#fff;
    cursor:pointer;
    font-size: 28px;
    line-height: 40px;
  }
  .slider-nav.left{ left: 10px; }
  .slider-nav.right{ right: 10px; }
</style>

<script>
  // Astro は <script> でクライアント側のイベント処理を追加できます :contentReference[oaicite:5]{index=5}

  // モーダル開閉
  document.querySelectorAll("[data-modal-open]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-modal-open");
      const dialog = document.querySelector(`dialog[data-modal="${id}"]`);
      if (dialog && typeof dialog.showModal === "function") dialog.showModal();
    });
  });

  document.querySelectorAll("[data-modal-close]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-modal-close");
      const dialog = document.querySelector(`dialog[data-modal="${id}"]`);
      if (dialog) dialog.close();
    });
  });

  // 背景クリックで閉じる（dialogの一般的な実装） :contentReference[oaicite:6]{index=6}
  document.querySelectorAll("dialog.work-modal").forEach((dialog) => {
    dialog.addEventListener("click", (e) => {
      const rect = dialog.getBoundingClientRect();
      const inDialog =
        rect.top <= e.clientY && e.clientY <= rect.bottom &&
        rect.left <= e.clientX && e.clientX <= rect.right;
      if (!inDialog) dialog.close();
    });
  });

  // 依存なし簡易スライダー（scrollIntoView）
  function setupSlider(id) {
    const slidesEl = document.querySelector(`[data-slides="${id}"]`);
    if (!slidesEl) return;

    const slides = Array.from(slidesEl.querySelectorAll("[data-slide]"));
    if (slides.length <= 1) return;

    let index = 0;
    const go = (next) => {
      index = (next + slides.length) % slides.length;
      slides[index].scrollIntoView({ behavior: "smooth", inline: "start", block: "nearest" });
    };

    document.querySelector(`[data-slide-prev="${id}"]`)?.addEventListener("click", () => go(index - 1));
    document.querySelector(`[data-slide-next="${id}"]`)?.addEventListener("click", () => go(index + 1));
  }

  document.querySelectorAll("[data-slider]").forEach((el) => setupSlider(el.getAttribute("data-slider")));
</script>
